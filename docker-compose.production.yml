# Production Docker Compose for Coolify with Traefik
# Uses Coolify's built-in Traefik proxy for HTTPS
# PostgREST is internal-only (not exposed externally)

version: '3.8'

services:
  # PostgREST API - Internal only
  postgrest:
    image: postgrest/postgrest:v12.0.3
    container_name: karat-tracker20-postgrest
    expose:
      - "3000"  # Only exposed within Docker network
    environment:
      PGRST_DB_URI: ${PGRST_DB_URI}
      PGRST_DB_SCHEMAS: ${PGRST_DB_SCHEMAS:-public}
      PGRST_DB_ANON_ROLE: ${PGRST_DB_ANON_ROLE:-web_anon}
      PGRST_JWT_SECRET: ${PGRST_JWT_SECRET}
      PGRST_SERVER_HOST: ${PGRST_SERVER_HOST:-*}
      PGRST_SERVER_PORT: ${PGRST_SERVER_PORT:-3000}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 -O- http://127.0.0.1:3000/ 2>&1 | grep -q . || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - coolify  # Use Coolify's network for internal communication
    labels:
      # Traefik configuration for PostgREST API
      - "traefik.enable=true"
      - "traefik.http.routers.postgrest.rule=Host(`api.kt.eyediaworks.in`)"
      - "traefik.http.routers.postgrest.entrypoints=websecure"
      - "traefik.http.routers.postgrest.tls.certresolver=letsencrypt"
      - "traefik.http.services.postgrest.loadbalancer.server.port=3000"

  # Frontend Application
  frontend:
    container_name: karat-tracker20-frontend
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # API uses HTTPS through Traefik
        VITE_API_URL: https://api.kt.eyediaworks.in
        VITE_APP_NAME: ${VITE_APP_NAME:-Karat Tracker}
        VITE_APP_VERSION: ${VITE_APP_VERSION:-2.0.0}
        VITE_OPENAI_API_KEY: ${VITE_OPENAI_API_KEY:-}
    expose:
      - "80"  # Only exposed within Docker network
    depends_on:
      - postgrest
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - coolify  # Use Coolify's network
    labels:
      # Traefik configuration for Frontend
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`kt.eyediaworks.in`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"

networks:
  coolify:
    external: true  # Use Coolify's existing network
